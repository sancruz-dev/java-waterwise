<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>Notifica√ß√µes - WaterWise</title>
    <style>
        .notification-item {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .notification-item.notification-danger { border-left-color: #dc3545; }
        .notification-item.notification-warning { border-left-color: #ffc107; }
        .notification-item.notification-success { border-left-color: #198754; }
        .notification-item.notification-info { border-left-color: #0dcaf0; }
        .notification-item.unread {
            background: linear-gradient(90deg, rgba(13, 202, 240, 0.1) 0%, rgba(255,255,255,1) 100%);
        }
        .badge-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .integration-status.online { color: #198754; }
        .integration-status.offline { color: #dc3545; }
        .integration-status.loading { color: #6c757d; }
    </style>
</head>

<!-- Main Content -->
<div layout:fragment="content">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 text-primary">
                <i class="bi bi-bell me-2"></i>Central de Notifica√ß√µes
            </h1>
            <p class="text-muted">
                Acompanhe alertas e eventos do sistema em tempo real
                <span id="integrationStatus" class="integration-status loading ms-2">
                    <i class="bi bi-circle-fill"></i> Verificando integra√ß√£o .NET...
                </span>
            </p>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button onclick="atualizarNotificacoes()" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                </button>
                <button onclick="limparTodas()" class="btn btn-outline-danger">
                    <i class="bi bi-trash me-1"></i>Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-bell display-6"></i>
                    <h3 id="totalNotificacoes" th:text="${total ?: 0}">0</h3>
                    <small>Total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-white">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle display-6"></i>
                    <h3 id="totalNovas">0</h3>
                    <small>N√£o Lidas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-cpu display-6"></i>
                    <h3 id="totalSensores">0</h3>
                    <small>Sensores .NET</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div id="integracaoCard" class="card border-0 bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-link-45deg display-6"></i>
                    <h3 id="integracaoStatus">?</h3>
                    <small>Integra√ß√£o .NET</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Notifica√ß√µes -->
    <div class="card border-0 shadow-sm">
        <div class="card-header  border-0">
            <h5 class="card-title mb-0">
                <i class="bi bi-list-ul text-info me-2"></i>
                Lista de Notifica√ß√µes
            </h5>
        </div>
        <div class="card-body p-0">
            <div id="listaNotificacoes">
                <!-- Ser√° preenchido via JavaScript -->
                <div class="text-center text-muted py-5">
                    <i class="bi bi-bell-slash display-1 opacity-25"></i>
                    <p class="mt-3">Carregando notifica√ß√µes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class=" border-top mt-5 py-4">
    <div class="container text-center">
        <p class="text-muted mb-0">
            <i class="bi bi-droplet-fill text-primary me-1"></i>
            <strong>WaterWise</strong> ¬© 2025 - Sistema de Preven√ß√£o a Enchentes
            <span class="ms-3">
                <i class="bi bi-link-45deg text-info"></i>
                Integrado com API .NET via RabbitMQ
            </span>
        </p>
    </div>
</footer>

<th:block layout:fragment="page-scripts">
<script>
    // üîÑ ATUALIZAR NOTIFICA√á√ïES
    function atualizarNotificacoes() {
        console.log('üîÑ Atualizando notifica√ß√µes...');
        
        // Mostrar loading
        document.getElementById('listaNotificacoes').innerHTML = `
            <div class="text-center text-muted py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Atualizando notifica√ß√µes...</p>
            </div>
        `;

        fetch('/admin/notificacoes/api/lista')
            .then(response => {
                console.log('üì° Resposta recebida:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üìä Dados recebidos:', data);
                renderizarNotificacoes(data.notificacoes);
                atualizarEstatisticas(data);
                console.log(`‚úÖ ${data.total} notifica√ß√µes carregadas`);
                
                // Feedback visual
                showToast(`${data.total} notifica√ß√µes atualizadas`, 'success');
            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar notifica√ß√µes:', error);
                document.getElementById('listaNotificacoes').innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle display-1 text-danger opacity-25"></i>
                    <h5 class="text-danger mt-3">Erro ao carregar notifica√ß√µes</h5>
                    <p class="text-muted">${error.message}</p>
                    <button onclick="atualizarNotificacoes()" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-clockwise me-1"></i>Tentar novamente
                    </button>
                </div>
            `;
                
                showToast('Erro ao atualizar notifica√ß√µes', 'error');
            });
    }

    // üîó VERIFICAR STATUS DA INTEGRA√á√ÉO .NET
    function verificarStatusIntegracao() {
        fetch('/admin/integracao/status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('integracaoStatus');
                const cardElement = document.getElementById('integracaoCard');
                const headerStatus = document.getElementById('integrationStatus');
                
                if (data.rabbitmqConectado) {
                    statusElement.textContent = '‚úÖ';
                    cardElement.className = 'card border-0 bg-success text-white';
                    headerStatus.innerHTML = '<i class="bi bi-circle-fill"></i> Integra√ß√£o .NET ativa';
                    headerStatus.className = 'integration-status online ms-2';
                } else {
                    statusElement.textContent = '‚ùå';
                    cardElement.className = 'card border-0 bg-danger text-white';
                    headerStatus.innerHTML = '<i class="bi bi-circle-fill"></i> Integra√ß√£o .NET offline';
                    headerStatus.className = 'integration-status offline ms-2';
                }
                
                console.log('üîó Status integra√ß√£o:', data.mensagem);
            })
            .catch(error => {
                console.warn('‚ö†Ô∏è Integra√ß√£o .NET n√£o configurada:', error);
                document.getElementById('integracaoStatus').textContent = '‚ö†Ô∏è';
                document.getElementById('integracaoCard').className = 'card border-0 bg-warning text-white';
                document.getElementById('integrationStatus').innerHTML = '<i class="bi bi-circle-fill"></i> Integra√ß√£o .NET n√£o configurada';
                document.getElementById('integrationStatus').className = 'integration-status offline ms-2';
            });
    }

    // üß™ TESTAR INTEGRA√á√ÉO .NET
    function testarIntegracao() {
        fetch('/admin/integracao/teste', { method: 'POST' })
            .then(response => response.text())
            .then(message => {
                showToast('Teste de integra√ß√£o executado!', 'success');
                setTimeout(atualizarNotificacoes, 500);
            })
            .catch(error => {
                console.error('‚ùå Erro no teste:', error);
                showToast('Erro no teste de integra√ß√£o', 'error');
            });
    }

    // üé® RENDERIZAR LISTA
    function renderizarNotificacoes(notificacoes) {
        const lista = document.getElementById('listaNotificacoes');

        if (notificacoes.length === 0) {
            lista.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-bell-slash display-1 opacity-25"></i>
                <h5 class="text-muted mt-3">Nenhuma notifica√ß√£o</h5>
                <p class="mb-0">As notifica√ß√µes aparecer√£o aqui quando eventos ocorrerem</p>
            </div>
        `;
            return;
        }

        lista.innerHTML = notificacoes.map(n => `
        <div class="notification-item notification-${n.tipo.toLowerCase()} p-3 border-bottom ${!n.lida ? 'unread' : ''}"
             onclick="marcarComoLida('${n.id}')">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    ${getIconeNotificacao(n.tipo, n.origem)}
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="mb-1 fw-bold">${n.titulo}</h6>
                        <small class="text-muted">${n.timeFormatted}</small>
                    </div>
                    <p class="mb-2 text-muted">${n.mensagem}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${getTipoClass(n.tipo)} badge-sm">${getOrigemLabel(n.origem)}</span>
                        ${!n.lida ? '<span class="badge bg-warning badge-pulse">NOVA</span>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    }

    // üéØ √çCONES POR TIPO E ORIGEM
    function getIconeNotificacao(tipo, origem) {
        const origemIcons = {
            'DOTNET_SENSOR': 'bi-cpu-fill text-primary',
            'DOTNET_API': 'bi-cloud-arrow-down-fill text-info',
            'SENSOR': 'bi-broadcast text-success',
            'ALERTA': 'bi-bell-fill text-warning',
            'SISTEMA': 'bi-gear-fill text-secondary',
            'TESTE': 'bi-flask text-muted'
        };

        const tipoColors = {
            'DANGER': 'text-danger',
            'WARNING': 'text-warning',
            'SUCCESS': 'text-success',
            'INFO': 'text-info'
        };

        const baseIcon = origemIcons[origem] || 'bi-bell text-primary';
        const colorClass = tipoColors[tipo.toUpperCase()] || 'text-primary';
        
        return `<i class="bi ${baseIcon.split(' ')[0]} ${colorClass} fs-4"></i>`;
    }

    // üè∑Ô∏è LABELS DAS ORIGENS
    function getOrigemLabel(origem) {
        const labels = {
            'DOTNET_SENSOR': '.NET Sensor',
            'DOTNET_API': '.NET API',
            'SENSOR': 'Sensor IoT',
            'ALERTA': 'Alerta',
            'SISTEMA': 'Sistema',
            'TESTE': 'Teste'
        };
        return labels[origem] || origem;
    }

    // üé® CLASSES CSS
    function getTipoClass(tipo) {
        const classes = {
            'DANGER': 'danger',
            'WARNING': 'warning',
            'SUCCESS': 'success',
            'INFO': 'info'
        };
        return classes[tipo.toUpperCase()] || 'secondary';
    }

    // üìä ATUALIZAR ESTAT√çSTICAS
    function atualizarEstatisticas(data) {
        document.getElementById('totalNotificacoes').textContent = data.total;
        document.getElementById('totalNovas').textContent = data.novas;
        document.getElementById('totalSensores').textContent = data.totalSensores || 0;

        // Badge no navbar
        const badge = document.getElementById('badgeNovas');
        if (badge) {
            if (data.novas > 0) {
                badge.textContent = data.novas;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // ‚úÖ MARCAR COMO LIDA
    function marcarComoLida(id) {
        fetch(`/admin/notificacoes/marcar-lida/${id}`, { method: 'POST' })
            .then(() => atualizarNotificacoes())
            .catch(error => console.error('Erro ao marcar como lida:', error));
    }

    // üß™ CRIAR TESTE LOCAL
    function criarTeste() {
        fetch('/admin/notificacoes/teste', { method: 'POST' })
            .then(() => {
                setTimeout(atualizarNotificacoes, 500);
                showToast('Notifica√ß√£o de teste criada!', 'success');
            })
            .catch(error => console.error('Erro ao criar teste:', error));
    }

    // üßπ LIMPAR TODAS
    function limparTodas() {
        if (confirm('Tem certeza que deseja limpar todas as notifica√ß√µes?')) {
            fetch('/admin/notificacoes/limpar', { method: 'POST' })
                .then(() => {
                    atualizarNotificacoes();
                    showToast('Notifica√ß√µes limpas!', 'info');
                })
                .catch(error => console.error('Erro ao limpar:', error));
        }
    }

    // üçû TOAST DE FEEDBACK
    function showToast(message, type = 'info') {
        // Mapear tipos para classes Bootstrap
        const typeMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'info'
        };
        
        const bootstrapType = typeMap[type] || 'info';
        
        // Criar toast
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast show position-fixed top-0 end-0 m-3" style="z-index: 9999;">
                <div class="toast-header">
                    <i class="bi bi-bell text-${bootstrapType} me-2"></i>
                    <strong class="me-auto">WaterWise</strong>
                    <small class="text-muted">agora</small>
                    <button type="button" class="btn-close" onclick="document.getElementById('${toastId}').remove()"></button>
                </div>
                <div class="toast-body bg-${bootstrapType} text-white">
                    ${message}
                </div>
            </div>
        `;
        
        // Adicionar ao DOM
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        
        // Remover automaticamente ap√≥s 3 segundos
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, 3000);
        
        console.log(`üçû Toast: ${message}`);
    }

    // üêõ TESTE DE DEBUG
    function testarEndpoint() {
        console.log('üêõ Testando endpoint de notifica√ß√µes...');
        
        fetch('/admin/notificacoes/api/lista', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('üì° Status da resposta:', response.status);
            console.log('üì° Headers:', [...response.headers.entries()]);
            console.log('üì° URL:', response.url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.text(); // Primeiro como texto para debug
        })
        .then(text => {
            console.log('üìÑ Resposta em texto:', text);
            
            try {
                const data = JSON.parse(text);
                console.log('‚úÖ JSON parseado:', data);
                showToast(`Endpoint funcionando! ${data.total || 0} notifica√ß√µes`, 'success');
            } catch (e) {
                console.error('‚ùå Erro ao parsear JSON:', e);
                showToast('Resposta n√£o √© JSON v√°lido', 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            showToast(`Erro: ${error.message}`, 'error');
        });
    }

    // üöÄ INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Iniciando sistema de notifica√ß√µes...');
        
        // Verificar se elementos existem
        const elementos = {
            'listaNotificacoes': document.getElementById('listaNotificacoes'),
            'totalNotificacoes': document.getElementById('totalNotificacoes'),
            'totalNovas': document.getElementById('totalNovas'),
            'totalSensores': document.getElementById('totalSensores'),
            'integracaoStatus': document.getElementById('integracaoStatus')
        };
        
        console.log('üîç Elementos encontrados:', elementos);
        
        // Primeira carga
        atualizarNotificacoes();
        verificarStatusIntegracao();

        // Auto-refresh a cada 30 segundos
        setInterval(atualizarNotificacoes, 30000);
        
        // Verificar status da integra√ß√£o a cada 60 segundos
        setInterval(verificarStatusIntegracao, 60000);

        console.log('üîî Sistema de notifica√ß√µes iniciado!');
        console.log('üîó Monitoramento de integra√ß√£o .NET ativo');
    });
</script>
</th:block>
</html>