<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
  <title th:text="${sensor.idSensor != null ? 'Editar Sensor IoT' : 'Novo Sensor IoT'} + ' - WaterWise'">Novo Sensor IoT - WaterWise</title>
</head>

<div layout:fragment="content">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
          <li class="breadcrumb-item"><a th:href="@{/admin/sensores}">Sensores IoT</a></li>
          <li class="breadcrumb-item active" th:text="${sensor.idSensor != null ? 'Editar' : 'Novo Sensor'}">
            Novo Sensor
          </li>
        </ol>
      </nav>
      <h1 class="h2 text-primary">
        <i class="bi bi-cpu me-2"></i>
        <span th:text="${sensor.idSensor != null ? 'Editar Sensor IoT' : 'Novo Sensor IoT'}">
          Novo Sensor IoT
        </span>
      </h1>
      <p class="text-muted">
        Gerenciamento de sensores IoT para monitoramento ambiental
      </p>
    </div>
  </div>

  <div class="row">
    <!-- Formul√°rio Principal -->
    <div class="col-lg-8">
      <form th:action="@{/admin/sensores}" th:object="${sensor}" method="post">
        <input type="hidden" th:field="*{idSensor}" />
        
        <!-- Informa√ß√µes B√°sicas -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0">
            <h5 class="card-title mb-0">
              <i class="bi bi-info-circle text-primary me-2"></i>
              Informa√ß√µes do Sensor
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="idPropriedade" class="form-label">Propriedade Rural *</label>
                <select class="form-select" id="idPropriedade" 
                        th:field="*{idPropriedade}"
                        th:classappend="${#fields.hasErrors('idPropriedade')} ? 'is-invalid' : ''"
                        required>
                  <option value="">Selecione uma propriedade</option>
                  <option th:each="propriedade : ${propriedades}"
                          th:value="${propriedade.idPropriedade}"
                          th:text="${propriedade.nomePropriedade} + ' - ' + ${propriedade.produtor?.nomeCompleto ?: 'N√£o informado'}">
                  </option>
                </select>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('idPropriedade')}"
                     th:errors="*{idPropriedade}">
                  Selecione uma propriedade
                </div>
                <small class="form-text text-muted">
                  Propriedade onde o sensor ser√° instalado
                </small>
              </div>
              <div class="col-md-6 mb-3">
                <label for="idTipoSensor" class="form-label">Tipo de Sensor *</label>
                <select class="form-select" id="idTipoSensor" 
                        th:field="*{idTipoSensor}"
                        th:classappend="${#fields.hasErrors('idTipoSensor')} ? 'is-invalid' : ''"
                        required>
                  <option value="">Selecione o tipo</option>
                  <option th:each="tipoSensor : ${tiposSensores}"
                          th:value="${tipoSensor.idTipoSensor}"
                          th:text="${tipoSensor.nomeTipo}"
                          th:data-unidade="${tipoSensor.unidadeMedida}"
                          th:data-desc="${tipoSensor.descricao}"
                          th:data-min="${tipoSensor.valorMin}"
                          th:data-max="${tipoSensor.valorMax}">
                  </option>
                </select>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('idTipoSensor')}"
                     th:errors="*{idTipoSensor}">
                  Selecione um tipo de sensor
                </div>
                <small class="form-text text-muted" id="tipoDesc">
                  Tipo de medi√ß√£o que o sensor realizar√°
                </small>
              </div>
            </div>

            <div class="row">
              <div class="col-md-8 mb-3">
                <label for="modeloDispositivo" class="form-label">Modelo do Dispositivo</label>
                <input type="text" class="form-control" id="modeloDispositivo"
                       th:field="*{modeloDispositivo}"
                       placeholder="Ex: WaterWise-UM-2024-A1"
                       th:classappend="${#fields.hasErrors('modeloDispositivo')} ? 'is-invalid' : ''">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('modeloDispositivo')}"
                     th:errors="*{modeloDispositivo}">
                  Erro no modelo do dispositivo
                </div>
                <small class="form-text text-muted">
                  Identifica√ß√£o do modelo/vers√£o do sensor
                </small>
              </div>
              <div class="col-md-4 mb-3">
                <label for="dataInstalacao" class="form-label">Data de Instala√ß√£o</label>
                <input type="datetime-local" class="form-control" id="dataInstalacao" 
                       th:field="*{dataInstalacao}"
                       th:classappend="${#fields.hasErrors('dataInstalacao')} ? 'is-invalid' : ''">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('dataInstalacao')}"
                     th:errors="*{dataInstalacao}">
                  Data inv√°lida
                </div>
                <small class="form-text text-muted">
                  Deixe vazio para usar data atual
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Configura√ß√µes T√©cnicas -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0">
            <h5 class="card-title mb-0">
              <i class="bi bi-gear text-info me-2"></i>
              Configura√ß√µes T√©cnicas
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Faixa de Opera√ß√£o</label>
                <div class="input-group">
                  <input type="number" class="form-control" placeholder="Min"
                         id="valorMin" readonly>
                  <span class="input-group-text">-</span>
                  <input type="number" class="form-control" placeholder="Max"
                         id="valorMax" readonly>
                  <span class="input-group-text" id="unidadeMedida">-</span>
                </div>
                <small class="form-text text-muted">
                  Definida automaticamente pelo tipo de sensor
                </small>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Frequ√™ncia de Leitura</label>
                <select class="form-select">
                  <option value="15">A cada 15 minutos</option>
                  <option value="30" selected>A cada 30 minutos</option>
                  <option value="60">A cada 1 hora</option>
                  <option value="180">A cada 3 horas</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Status Inicial</label>
                <select class="form-select" name="statusOperacional">
                  <option value="A" selected>üü¢ Ativo</option>
                  <option value="I">üî¥ Inativo</option>
                  <option value="M">üü° Manuten√ß√£o</option>
                </select>
              </div>
            </div>

            <div class="alert alert-info border-0" th:if="!${sensor.idSensor}">
              <i class="bi bi-lightbulb me-2"></i>
              <strong>Dica:</strong> Ap√≥s a instala√ß√£o, o sensor come√ßar√° a enviar dados automaticamente.
              Monitore os primeiros dados para verificar se est√° funcionando corretamente.
            </div>
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <a th:href="@{/admin/sensores}" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-1"></i>
                  Voltar
                </a>
              </div>
              <div>
                <button type="button" class="btn btn-outline-warning me-2" onclick="resetForm()">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Limpar
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-check-circle me-1"></i>
                  <span th:text="${sensor.idSensor != null ? 'Atualizar' : 'Cadastrar'} + ' Sensor'">
                    Cadastrar Sensor
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Sidebar - Informa√ß√µes de Ajuda -->
    <div class="col-lg-4">
      <!-- Preview do Sensor -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-eye text-primary me-2"></i>
            Preview do Sensor
          </h5>
        </div>
        <div class="card-body text-center">
          <div id="sensorPreview">
            <i class="bi bi-cpu display-1 text-muted opacity-25 mb-3"></i>
            <h6 class="text-muted">Selecione o tipo de sensor</h6>
            <p class="text-muted small mb-0">
              As especifica√ß√µes aparecer√£o aqui
            </p>
          </div>
        </div>
      </div>

      <!-- Tipos de Sensores Dispon√≠veis -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-collection text-info me-2"></i>
            Tipos Dispon√≠veis
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-droplet text-primary me-2"></i>
              <strong>Umidade do Solo</strong>
            </div>
            <p class="small text-muted mb-0">
              Monitora a umidade do solo para detectar condi√ß√µes de seca ou encharcamento
            </p>
          </div>
          <hr>
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-thermometer text-warning me-2"></i>
              <strong>Temperatura do Ar</strong>
            </div>
            <p class="small text-muted mb-0">
              Mede a temperatura ambiente para an√°lise de condi√ß√µes clim√°ticas
            </p>
          </div>
          <hr>
          <div class="mb-0">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-cloud-rain text-info me-2"></i>
              <strong>Precipita√ß√£o</strong>
            </div>
            <p class="small text-muted mb-0">
              Detecta e mede a quantidade de chuva para monitoramento de enchentes
            </p>
          </div>
        </div>
      </div>

      <!-- Status do Sistema -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="card-title mb-0">
            <i class="bi bi-info-circle text-success me-2"></i>
            Status do Sistema
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6 class="text-muted mb-1">Sensores Ativos</h6>
            <h4 class="text-success mb-0">12</h4>
          </div>
          <div class="mb-3">
            <h6 class="text-muted mb-1">Propriedades Monitoradas</h6>
            <h4 class="text-primary mb-0">8</h4>
          </div>
          <hr>
          <p class="small text-muted mb-0">
            Sistema de monitoramento IoT para preven√ß√£o de enchentes em Mairipor√£-SP
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="page-scripts">
<script>
  // Atualizar preview quando mudar o tipo de sensor
  document.getElementById('idTipoSensor').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const unidade = selectedOption.getAttribute('data-unidade');
    const desc = selectedOption.getAttribute('data-desc');
    const valorMin = selectedOption.getAttribute('data-min');
    const valorMax = selectedOption.getAttribute('data-max');
    const tipoTexto = selectedOption.textContent;

    const preview = document.getElementById('sensorPreview');
    const tipoDesc = document.getElementById('tipoDesc');
    const unidadeMedida = document.getElementById('unidadeMedida');
    const inputMin = document.getElementById('valorMin');
    const inputMax = document.getElementById('valorMax');

    if (unidade && desc) {
      preview.innerHTML = `
        <i class="bi bi-cpu display-1 text-success mb-3"></i>
        <h6 class="text-success">${tipoTexto}</h6>
        <p class="text-muted small mb-0">${desc}</p>
      `;
      tipoDesc.textContent = desc;
      unidadeMedida.textContent = unidade || '-';
      inputMin.value = valorMin || '';
      inputMax.value = valorMax || '';
    } else {
      preview.innerHTML = `
        <i class="bi bi-cpu display-1 text-muted opacity-25 mb-3"></i>
        <h6 class="text-muted">Selecione o tipo de sensor</h6>
        <p class="text-muted small mb-0">As especifica√ß√µes aparecer√£o aqui</p>
      `;
      tipoDesc.textContent = 'Tipo de medi√ß√£o que o sensor realizar√°';
      unidadeMedida.textContent = '-';
      inputMin.value = '';
      inputMax.value = '';
    }
  });

  // Definir data atual como padr√£o se for um novo sensor
  document.addEventListener('DOMContentLoaded', function() {
    const dataInstalacao = document.getElementById('dataInstalacao');
    
    // S√≥ define data atual se for um novo sensor (campo vazio)
    if (!dataInstalacao.value) {
      const agora = new Date();
      agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
      dataInstalacao.value = agora.toISOString().slice(0, 16);
    }

    // Trigger para carregar preview se j√° tem tipo selecionado (edi√ß√£o)
    document.getElementById('idTipoSensor').dispatchEvent(new Event('change'));
  });

  // Resetar formul√°rio
  function resetForm() {
    if (confirm('Tem certeza que deseja limpar o formul√°rio?')) {
      document.querySelector('form').reset();
      const agora = new Date();
      agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
      document.getElementById('dataInstalacao').value = agora.toISOString().slice(0, 16);

      document.getElementById('sensorPreview').innerHTML = `
        <i class="bi bi-cpu display-1 text-muted opacity-25 mb-3"></i>
        <h6 class="text-muted">Selecione o tipo de sensor</h6>
        <p class="text-muted small mb-0">As especifica√ß√µes aparecer√£o aqui</p>
      `;
    }
  }
</script>
</th:block>
</html>